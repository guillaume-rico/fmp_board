<!DOCTYPE html>
<html>
  <head>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
		<title>FMP Board Generator</title>
		
		<script type="text/javascript" src="src/d3.min.js"></script>
		<script type="text/javascript" src="src/d3.hexbin.min.js"></script>	
		<script type="text/javascript" src="src/jquery-2.2.0.min.js"></script>
		<script type="text/javascript" src="js/generate.js"></script>
		<script type="text/javascript" src="js/tosvg.js"></script>

		<style type="text/css">
			body {
				margin: 0px; 
				overflow: hidden; 
				font-family: "Helvetica Neue", Helvetica; 
				font-size: 14px;
			}

			.header {
				margin-top: 20px;
				margin-left: 20px;
				font-size: 36px; 
				font-weight: 300; 
				display: block; 
				z-index: 1; 
				text-shadow: 0 1px 0 #fff;
			}
			.control {
				margin-top: 5px;
				margin-left: 20px;
				display: block; 
				z-index: 1; 
				text-shadow: 0 1px 0 #fff;
			}
			.hint {
				width: 1280px; 
				right: 0px; 
				color: rgb(153, 153, 153); 
				font-size: 12px;
				padding-bottom: 5px;
			}

			.hr-style {
			   border: 0;
			   height: 2px;
			   width: 80%;
			   color: #E8E8E8;
			   background-color: #E8E8E8;
			}
		</style>
	</head>
	<body>
	    <div class="header">
			Generation de carte pour Full Metal Planet
			<div class="hint">Cliquer sur une case pour changer la nature du sol</div>
		</div>
        <div class="control">
            <div class="size">
                largeur : <input id="largeur" type="text" size="10" value="23">
                hauteur : <input id="hauteur" type="text" size="10" value="37">
                 <input id="valider" type="button" size="10" value="Recharger" onclick="computeboard();">
            <div>
            <div class="download">
                 <input id="valider" type="button" size="10" value="Telecharger" onclick="download();">
            <div>
        <div>

        
		<div id="chart"></div>
		
<!-- <svg height="10" width="10" xmlns="http://www.w3.org/2000/svg" version="1.1"> <defs> <pattern id="" patternUnits="" width="10" height="10"> <image xlink:href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScxMCcgaGVpZ2h0PScxMCc+CiAgPHJlY3Qgd2lkdGg9JzEwJyBoZWlnaHQ9JzEwJyBmaWxsPSd3aGl0ZScgLz4KICA8Y2lyY2xlIGN4PSczJyBjeT0nMycgcj0nMycgZmlsbD0nYmxhY2snLz4KPC9zdmc+Cg==" x="0" y="0" width="10" height="10"> </image> </pattern> </defs> </svg> -->

                        
		<script type="text/javascript">
        
            // A faire :
            // * Export SVG
            // * Sauvegarde carte 
            // * Sélection coef
            // * Motif : i et a 

            
           //Function to call when you mouseover a node
            function mover(d) {
              var el = d3.select(this)
                    .transition()
                    .duration(10)		  
                    .style("fill-opacity", 0.3)
                    ;
            }

            //Mouseout function
            function mout(d) { 
                var el = d3.select(this)
                   .transition()
                   .duration(1000)
                   .style("fill-opacity", 1)
                   ;
            };
            
            //Mouseclick function
            function mclick(d) { 

                var el = d3.select(this);
                //alert(el.data());
                // On incrémente
                var groundstyle =  parseInt(el.attr("groundstyle")) + 1 ;
                if (groundstyle > 5) {
                    groundstyle = 1 ;
                }
                // On sauvegarde
                el.attr("groundstyle",groundstyle);
                // On met a jour l'affichage
                el.style("fill", definecolor(shortintoval(groundstyle)));
            };
            
            
           ///////////////////////////////////////////////////////////////////////////
            ////////////// Initiate SVG and create hexagon centers ////////////////////
            ///////////////////////////////////////////////////////////////////////////

            //svg sizes and margins
            var margin = {
                top: 30,
                right: 20,
                bottom: 50,
                left: 50
            };

            var svg;
            var nbRow = 23;
            var nbCol = 23;
            function computeboard() {
    

                //The next lines should be run, but this seems to go wrong on the first load in bl.ocks.org
                var width = $(window).width() - margin.left - margin.right - 40;
                var height = $(window).height() - margin.top - margin.bottom - 80;
                //So I set it fixed to
                //var width = 900;
                //var height = 900;

                // On vient charger le nb de col et de ligne
        
                nbRow = parseInt(document.getElementById("hauteur").value);
                nbCol = parseInt(document.getElementById("largeur").value);
                

                //The number of columns and rows of the heatmap
                var MapColumns = nbCol,
                    MapRows = nbRow;
                    
                //The maximum radius the hexagons can have to still fit the screen
                var hexRadius = d3.min([width/((MapColumns + 0.5) * Math.sqrt(3)),
                            height/((MapRows + 1/3) * 1.5)]);

                //Set the new height and width of the SVG based on the max possible
                width = MapColumns*hexRadius*Math.sqrt(3);
                height = MapRows*1.5*hexRadius+0.5*hexRadius;

                //Set the hexagon radius
                var hexbin = d3.hexbin()
                               .radius(hexRadius);

                //Calculate the center positions of each hexagon	
                var points = [];
                for (var i = 0; i < MapColumns; i++) {
                    for (var j = 0; j < MapRows; j++) {
                        points.push([hexRadius * i * 1.75, hexRadius * j * 1.5]);
                    }//for j
                }//for i
    
    
                // On supprime tout ce qui traine
                d3.select('svg').remove();

            
                //var display = document.getElementById('display');
                //var ctx = display.getContext('2d');
                //var width = display.width = window.innerWidth;
                //var height = display.height = window.innerHeight;
                // On calcul la taille de la grille a générer
                var terrain = new Terrain(nbCol,nbRow);
                // On réalise le tour de la carte
                terrain.tourdecarte();
                //terrain.generate();
                terrain.stat();
                // On ajoute les montagne 0.0293
                terrain.mountain(0.04);
                terrain.draw();
                
              

                ///////////////////////////////////////////////////////////////////////////
                ////////////// Initiate SVG and create hexagon centers ////////////////////
                ///////////////////////////////////////////////////////////////////////////

                //Create SVG element
                svg = d3.select("#chart").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                svg
                  .append('defs')
                      .append('pattern')
                        .attr('id', 'diagonalHatch')
                        .attr('patternUnits', 'userSpaceOnUse')
                        .attr('width', 4)
                        .attr('height', 4)
                      .append('path')
                        .attr('d', 'M-1,1 l2,-2 M0,4 l4,-4 M3,5 l2,-2')
                        .attr('stroke', '#000000')
                        .attr('stroke-width', 1);
                svg
                  .append('defs')
                      .append('pattern')
                        .attr('id', 'circles-5')
                        .attr('patternUnits', 'userSpaceOnUse')
                        .attr('width', 10)
                        .attr('height', 10)
                      .append('image')
                        .attr('xlink:href', 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScxMCcgaGVpZ2h0PScxMCc+CiAgPHJlY3Qgd2lkdGg9JzEwJyBoZWlnaHQ9JzEwJyBmaWxsPSd3aGl0ZScgLz4KICA8Y2lyY2xlIGN4PSczJyBjeT0nMycgcj0nMycgZmlsbD0nYmxhY2snLz4KPC9zdmc+Cg==')
                        .attr('x', 0)
                        .attr('y', 0)
                        .attr('width', 10)
                        .attr('height', 10);

                var fillMarecage = svg.append("pattern")
                    .attr("id", "marecage")
                    .attr("patternUnits", "userSpaceOnUse")
                    .attr("width", 10)
                    .style("fill", "rgba(201,145,83,1)")
                    .attr("height", 10);
                    //.attr("patternTransform", "rotate(45)");
                var fillMarecageRectangle2 = fillMarecage.append("rect")
                    .attr("height", 10)
                    .attr("width", 10)
                    .attr("fill", "rgba(201,145,83,1)"); 
                var fillMarecageRectangle = fillMarecage.append("rect")
                    .attr("height", 5)
                    .attr("width", 5)
                    .attr("fill", "rgba(80,130,156,1)"); 
                    
                var fillIlot = svg.append("pattern")
                    .attr("id", "ilot")
                    .attr("patternUnits", "userSpaceOnUse")
                    .attr("width", 10)
                    .style("fill", "rgba(201,145,83,1)")
                    .attr("height", 10);
                    //.attr("patternTransform", "rotate(45)");
                var fillIlotRectangle2 = fillIlot.append("rect")
                    .attr("height", 10)
                    .attr("width", 10)
                    .attr("fill", "rgba(80,130,156,1)"); 
                var fillIlotRectangle = fillIlot.append("rect")
                    .attr("height", 5)
                    .attr("width", 5)
                    .attr("fill", "rgba(201,145,83,1)"); 

                        
                ///////////////////////////////////////////////////////////////////////////
                ////////////////////// Draw hexagons and color them ///////////////////////
                ///////////////////////////////////////////////////////////////////////////

                //Start drawing the hexagons
                svg.append("g")
                    .selectAll(".hexagon")
                    .data(hexbin(points))
                    .enter().append("path")
                    .attr("class", "hexagon")
                    .attr("d", function (d) {
                        return "M" + d.x + "," + d.y + hexbin.hexagon();
                    })
                    .attr("stroke", function (d,i) {
                        return "#000";
                    })
                    .attr("stroke-width", "0.25px")
                    .style("fill", function (d,i) {
                        return color[i];
                    })
//                    .style("fill", "url(#circles-5)")
                    .attr("groundstyle", function (d,i) {
                        return groundstyle[i];
                    }) 
//                    .attr("fill", "url(#marecage" + ")")
//                    .style("background", "rgba(201,145,83,1)")
                    .on("mouseover", mover)
                    .on("mouseout", mout)
                    .on("click", mclick)
                    ;
            }
            
            computeboard();
            
            

            
        </script>

	</body>
</html>